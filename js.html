<script>
/*globals google, accounts, Browser */

function appendOptionsToSelect(array, selector, isAccounts) {
    var select = $(selector);
    select.empty();

    array.forEach(function (element, index) {
        var setValue = isAccounts ? index : element.id;
        var option = $('<option>')
            .attr('value', setValue)
            .text(element.name);
        select.append(option);
    });
}

var audit = {

    submit: function (e) {
        e.preventDefault();

        var data = JSON.stringify({
            ids: accounts[$('#account').val()],
            report: $('#report').val()
        });

        google.script.run
            .withSuccessHandler(this.close)
            .withFailureHandler(this.showError)
            .saveReportDataFromSidebar(data);
    },

    close: function () {
        google.script.host.close();
    },

    showError: function (error) {
        console.log(error);
        window.alert('An error has occured, please try again.');
        this.close();
        
    },

    init: function () {

        this.showAccounts(accounts);

        this.showReports(reports);

    },

    showAccounts: function (accounts) {
        appendOptionsToSelect(accounts, '#account', true);
    },

    showReports: function (reports) {
        appendOptionsToSelect(reports, '#report');
    }
};

$(function () {

    // load Google Analytics accounts
    audit.init();

    // form - submit
    $('#submit').on('click', $.proxy(audit.submit, audit));

    // form - close
    $('#close').on('click', $.proxy(audit.close, audit));

});
</script>