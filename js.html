<script>
/*globals google, accounts, Browser, reports */

var flag = false;

function appendOptionsToSelect(array, selector) {
    var select = $(selector);
    select.empty();

    array.forEach(function (element, index) {
        var setValue = selector === '#account' ? index : element.id;
        var option = $('<option>')
            .attr('value', setValue)
            .text(element.name);
        select.append(option);
    });
}

var audit = {
    submit: function (e) {
        var data = JSON.stringify({
            ids: accounts[$('#account').val()],
            report: $('#report').val()
        });

        e.preventDefault();

        google.script.run
            .withSuccessHandler(this.close)
            .withFailureHandler(this.showError)
            .saveReportDataFromSidebar(data);
    },

    close: function () {
        google.script.host.close();
    },

    showError: function (error) {
        console.log(error);
        if (error && error.message && error.message === 'Quota Error: User Rate Limit Exceeded.') {
            if (!flag) {
                flag = true;
                window.alert('It looks like you\'ve you hit the user rate limit. ' + 
                    'We\'ll continue to ask for the data, but feel free to cancel ' + 
                    'the request and try again later.');
            }
            return setTimeout(function () {
                $('#submit').trigger('click');
            }, 1000);
        }

        console.log(error);
        window.alert('An error has occured, please try again.');
        this.close();

    },

    init: function () {

        this.showAccounts(accounts);

        this.showReports(reports);

    },

    showAccounts: function (accounts) {
        appendOptionsToSelect(accounts, '#account');
    },

    showReports: function (reports) {
        appendOptionsToSelect(reports, '#report');
    }
};

$(function () {

    // load Google Analytics accounts
    audit.init();

    // form - submit
    $('#submit').on('click', $.proxy(audit.submit, audit));

    // form - close
    $('#close').on('click', $.proxy(audit.close, audit));

});
</script>