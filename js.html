<script>
/*globals google, accounts */

function appendOptionsToSelect(array, selector) {
    var select = $(selector);
    select.empty();

    array.forEach(function (element, index) {
        var setValue = element.id;
        var option = $('<option>')
            .attr('value', setValue)
            .text(element.name);
        select.append(option);
    });
}

var audit = {

    submit: function () {
        var data = $(this).closest('form').serializeArray();
        google.script.run
            .withSuccessHandler(google.script.host.close)
            .withFailureHandler(this.showError)
            .saveReportDataFromSidebar(data);
    },

    close: function () {
        google.script.host.close();
    },

    showError: function (error) {
        console.log(error);
        Browser.msgBox('An error has occured, please try again.');
    },

    loadAccountsAndReports: function () {

        google.script.run
            .withSuccessHandler(this.showAccounts)
            .withFailureHandler(this.showError)
            .getAccounts();

        google.script.run
            .withSuccessHandler(this.showReports)
            .withFailureHandler(this.showError)
            .getReports();

    },

    showAccounts: function (accounts) {
        appendOptionsToSelect(accounts, '#account');
    },

    showReports: function (reports) {
        appendOptionsToSelect(reports, '#report');
    }
};

$(function () {

    // load Google Analytics accounts
    audit.loadAccountsAndReports();

    // initialize multi-selects
    $('select[multiple]').select2();

    // form - submit
    $('#submit').on('click', audit.submit);

    // form - close
    $('#close').on('click', audit.close);

});
</script>